---
title: "Genetic_KO_metabolite_plots"
author: "Sam Herr, Michael Gore"
email: "skh77@cornell.edu"
output: html_document
date: "2023-08-18"
---
This R markdown file is for Figure 6 

The outline for the code chunks:
1. Packages
2. Figure 6a - includes analysis and visualization
3. Figure 6b - include analysis and visualization
4. Percent increase code
5. Additional plotting to look at tocopherol isoforms in embryo tissue

Code chunk 2 and 3 are copied and pasted code but analyze different tissue types. Only code chunk 2 is commented somewhat well. Copy and pasting was the easier option at the time to do that instead write things into functions. Code could be much better written as well

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gdata)
library(data.table)
library(readxl)
library(tidyverse)
library(car)
library(DescTools)
library(patchwork)
library(multcomp)
```


```{r figure 6a}
###
re <-   read_xlsx("../data/figure6_data.xlsx", sheet = 2)[,-c(1,5)]
tissues <- c("9.3-41_Embryo","9.3-41_Endosperm","9.3-5_Embryo","9.3-5_Endosperm")
traits <- c("a.T", "d.T", "g.T", "a.T3", "d.T3", "g.T3", "Total.T", "Total.T3", "Total.TT3","Chla", "Total.Carots")
re$Genotype <- gsub("-","*",re$Genotype)

#format names for figures
re$Genotype <- gsub("\\+\\*\\*\\*", "por1/+;por2/por2", re$Genotype)
re$Genotype <- gsub("\\*\\*\\+\\*", "por1/por1;por2/+", re$Genotype)
re$Genotype <- gsub("\\*\\*\\*\\*", "por1/por1;por2/por2", re$Genotype)
re$Genotype <- gsub("\\+\\+\\*\\*", "por2/por2", re$Genotype)
re$Genotype <- gsub("\\*\\*\\+\\+", "por1/por1", re$Genotype)
re$Genotype <- gsub("\\+\\+\\+\\+", "WT",re$Genotype)

results_list <- list()
#get Embryo tissue
re <-   re[re$Tissue %in% c("9.3-5_Embryo", "9.3-41_Embryo"),]

#perform Tukey's HSD on every trait wanted
#check for outliers  
for ( i in 1: length(traits)){
  #get trait (i.e. tocochromonal) and tissue type
  x <-  unlist(as.vector( re[,traits[i]]))
  df <- data.frame("TT" = x, "Genotype" = re$Genotype, "tissue" = re$Tissue)
  df <- df [,c(1,2)]
  df$Genotype <- as.factor(df$Genotype)

  # perform aov test
  x <- aov(TT~ Genotype, df)
  # Identify outliers
  print(outlierTest(x, cutoff=0.05, order=TRUE))
 
  #perform Tukey HSD and get letters for plotting
  m <- TukeyHSD(x)
  gl <- glht(x, mcp(Genotype = "Tukey"))
  #get letters for ggplot
  tuk.cld2 <- cld(gl)$mcletters$Letters
  result_df <- data.frame(
    Genotype = names(tuk.cld2),
    name = rep(traits[i],4),
    cld = tuk.cld2
  )
  # Store the result data frame in the list
  results_list[[i]] <- result_df
}


tukey <- data.table::rbindlist(results_list)
tukey <- tukey[tukey$name %in% c("Total.T", "Total.T3","Total.Carots","Chla"),]

#Formatting for plot
#remove Rep, Sample_ID, Description columns
re <- re[,-c(2,3,5)]
re <- re %>% pivot_longer(!c(Tissue, Genotype))

#for annotations get the max observation for that trait
#letters will be place above that location
annotations <- re %>%
  group_by(name) %>%
  summarize(value = max(value), .groups = 'drop')

#rename some variables for plotting purposes
annotations <- left_join(tukey, annotations, by = c("name"))
annotations$name <- gsub(".T$", " Tocopherol", annotations$name)
annotations$name <- gsub(".T3$", " Tocotrienol", annotations$name)
annotations$name <- gsub(".Carots$", " Carotenoids", annotations$name)
annotations$name <- gsub("Chla", "Chlorophyll a", annotations$name)
re <- re[re$name %in% c("Total.T", "Total.T3","Total.Carots","Chla"),]
re$name <- gsub(".T$", " Tocopherol", re$name)
re$name <- gsub(".T3$", " Tocotrienol", re$name)
re$name <- gsub(".Carots$", " Carotenoids", re$name)
re$name <- gsub("Chla", "Chlorophyll a", re$name)
re$Tissue <- as.factor(re$Tissue)
re$Tissue <- gsub("_.*", "",re$Tissue)
re$Genotype <- factor(re$Genotype, level=c('WT', 'por2/por2','por1/+;por2/por2',  'por1/por1;por2/por2'  ))
re$name <- factor(re$name, levels = c("Total Carotenoids","Total Tocotrienol",  "Total Tocopherol", "Chlorophyll a"))
annotations$name <- factor(annotations$name, levels = c("Total Carotenoids", "Total Tocotrienol", "Total Tocopherol", "Chlorophyll a"))


#plot
ggplot(re,aes(x = Genotype, y=value, group=Genotype ,width=.8)) +
  geom_boxplot(aes(fill=Genotype)) + 
  geom_point(aes(colour = Tissue)) +
  #facet_wrap based on traits
  facet_wrap(~name, scales = "free", ncol = 4,
                strip.position = "top") +
  #add color for the family
    scale_color_manual(values =c("red", "black"))+
   scale_y_continuous(limits = c(0, NA)) +
  guides(color = guide_legend(override.aes = list(size = 7))) +
  #color for plant phenotype
  scale_fill_manual(values =c( "#004D40","#004D40",  "greenyellow","#FFC107"))+
  theme_bw()+
  labs(color = "Family")+
  xlab("")+
  theme(
        legend.text = element_text(size = 10),
          plot.title.position = "plot",
        axis.title=element_text(size=30),
        panel.spacing = unit(4, "lines"),
        strip.text = element_text(size = 20),
               axis.text.x = element_text(size=15,face = "italic",colour = "black",angle = 45,hjust = 1, vjust = 1),
        text = element_text(family = "Helvetica"),
        axis.text.y = element_text(size=15,face="bold",colour = "black",angle = 0))+
  geom_text(data = annotations, aes(label = cld, y = value*1.1), position=position_dodge(width=0.9), color = "black", family= "sans", size = 5) +
  theme(legend.key.size = unit(8, 'cm')) 


ggsave("Figure6a.tiff", width = 24, height =8, device='tiff', dpi=700)



```
```{r figure 6b}
### data from 2022 analysis for 20GH fresh samples
re <-  read_xlsx("../data/20GH_POR_DATA_2022.xlsx", sheet = 2)[,-c(1,5)]
tissues <- c("9.3-41_Embryo","9.3-41_Endosperm","9.3-5_Embryo","9.3-5_Endosperm")
traits <- c("a.T", "d.T", "g.T", "a.T3", "d.T3", "g.T3", "Total.T", "Total.T3", "Total.TT3","Chla", "Total.Carots")
re$Genotype <- gsub("-","*",re$Genotype)


re$Genotype <- gsub("\\+\\*\\*\\*", "por1/+;por2/por2", re$Genotype)
re$Genotype <- gsub("\\*\\*\\+\\*", "por1/por1;por2/+", re$Genotype)
re$Genotype <- gsub("\\*\\*\\*\\*", "por1/por1;por2/por2", re$Genotype)
re$Genotype <- gsub("\\+\\+\\*\\*", "por2/por2", re$Genotype)
re$Genotype <- gsub("\\*\\*\\+\\+", "por1/por1", re$Genotype)
re$Genotype <- gsub("\\+\\+\\+\\+", "WT",re$Genotype)

#perfom Tukey's HSD on every trait wanted
for ( i in 1: length(traits)){
  print(traits[i])
  x <-  unlist(as.vector( re[,traits[i]]))
  df <- data.frame("TT" = x, "Genotype" = re$Genotype, "tissue" = re$Tissue)
  df <- df[df$tissue %in% c("9.3-5_Endosperm","9.3-41_Endosperm"),]
  df <- df [,c(1,2)]
  df$Genotype <- as.factor(df$Genotype)
  #perform Tukey's test
  if (sum(df$TT) == 0){
    next
  }
  alpha_adjusted <- 0.05 / length(df[,1])

  
  #perform Tukey's test
  x <- aov(TT~ Genotype, df)

  print(df)
  # Calculate critical value from t-distribution
  print(outlierTest(x, cutoff=0.05, order=TRUE))
  alpha_adjusted <- 0.05 / length(df[,1])
  critical_value <- qt(1 - alpha_adjusted/2, df = x$df.residual)
  # Identify outliers 
  outliers <- df[which(abs(deleted_res) > critical_value),]
  #print(outliers)
  gl <- glht(x, mcp(Genotype = "Tukey"))
  tuk.cld2 <- cld(gl)$mcletters$Letters
  result_df <- data.frame(
    Genotype = names(tuk.cld2),
    name = rep(traits[i],4),
    cld = tuk.cld2
  )
  # Store the result data frame in the list
  results_list[[i]] <- result_df
  #diff <- m[, "p adj"]
}
tukey <- data.table::rbindlist(results_list)

tukey <- tukey[tukey$name %in% c("Total.T", "Total.T3","Total.Carots","Chla"),]


re <-   re[re$Tissue %in% c("9.3-5_Endosperm", "9.3-41_Endosperm"),]
#remove Rep, Sample_ID, Description columns
re <- re[,-c(2,3,5)]
re <- re %>% pivot_longer(!c(Tissue, Genotype))

annotations <- re %>%
  group_by(name) %>%
  summarize(value = max(value), .groups = 'drop')

annotations <- left_join(tukey, annotations, by = c("name"))
annotations$name <- gsub(".T$", " Tocopherol", annotations$name)
annotations$name <- gsub(".T3$", " Tocotrienol", annotations$name)
annotations$name <- gsub(".Carots$", " Carotenoids", annotations$name)
annotations$name <- gsub("Chla", "Chlorophyll a", annotations$name)
#re[c("type", "geno")] <- str_split_fixed( re$name, "_", n =2)
#re <- re %>% pivot_wider(names_from = type, values_from = value)
re <- re[re$name %in% c("Total.T", "Total.T3","Total.Carots","Chla"),]
re$name <- gsub(".T$", " Tocopherol", re$name)
re$name <- gsub(".T3$", " Tocotrienol", re$name)
re$name <- gsub(".Carots$", " Carotenoids", re$name)
re$name <- gsub("Chla", "Chlorophyll a", re$name)
re$Tissue <- as.factor(re$Tissue)
re$Tissue <- gsub("_.*", "",re$Tissue)
re$Genotype <- factor(re$Genotype, level=c('WT', 'por2/por2','por1/+;por2/por2',  'por1/por1;por2/por2'  ))
re$name <- factor(re$name, levels = c("Total Carotenoids","Total Tocotrienol",  "Total Tocopherol", "Chlorophyll a"))
annotations$name <- factor(annotations$name, levels = c("Total Carotenoids", "Total Tocotrienol", "Total Tocopherol", "Chlorophyll a"))

ggplot(re,aes(x = Genotype, y=value ,width=.8)) +
  geom_boxplot(aes(fill=Genotype), show.legend =F) + 
  geom_point(aes(colour = Tissue)) +
    geom_text(data= annotations, aes(label = cld, y = value*1.1), position=position_dodge(width=0.9), color = "black", family= "sans", size = 5) +
  facet_wrap(vars(name), scales = "free", ncol = 4) +

    scale_color_manual(values =c("red", "black")) +
   scale_y_continuous(limits = c(0, NA)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  scale_fill_manual(values =c( "#004D40","#004D40",  "greenyellow","#FFC107")) +
  theme_bw() +
  labs(color = "Family") +
  xlab("") +
  theme(
        legend.text = element_text(size = 10),
          plot.title.position = "plot",
        axis.title=element_text(size=30),
        panel.spacing = unit(4, "lines"),
        strip.text = element_text(size = 20),
               axis.text.x = element_text(size=15,face = "italic",colour = "black",angle = 45,hjust = 1, vjust = 1),
        axis.text.y = element_text(size=15,face="bold",colour = "black",angle = 0)) +

  theme(legend.key.size = unit(4, 'cm')) 





ggsave("Figure6b.tiff", width = 24, height =8, device='tiff', dpi=700)

```

```{r percent increases for embryo tissue}
#calculates percentages for paper
calculate_percent_increase <- function(original_value, new_value) {
  # Calculate the difference
  difference <- new_value - original_value
  
  # Calculate percent increase
  percent_increase <- (difference / original_value) * 100
  
  # Return the percent increase
  return(percent_increase)
}

x <- re %>% group_by(Tissue, Genotype, name) %>% dplyr::summarise(mean_values = mean(value))

WT <- x %>% group_by(name, Tissue) %>% dplyr::mutate(percent = calculate_percent_increase(mean_values[Genotype == "WT"], mean_values[Genotype == "por1/por1;por2/por2"]))

por2 <- x %>% group_by(name, Tissue) %>% dplyr::mutate(percent = calculate_percent_increase(mean_values[Genotype == "por2/por2"], mean_values[Genotype == "por1/por1;por2/por2"]))

por1 <- x %>% group_by(name, Tissue) %>% dplyr::mutate(percent = calculate_percent_increase(mean_values[Genotype == "por1/+;por2/por2"], mean_values[Genotype == "por1/por1;por2/por2"]))


```
