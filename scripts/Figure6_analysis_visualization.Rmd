---
title: "Genetic_KO_metabolite_plots"
author: "Sam Herr, Michael Gore"
email: "skh77@cornell.edu"
output: html_document
date: "2023-08-18"
---
This R markdown file is for Figure 6 

The outline for the code chunks:
1. Packages
2. Figure 6a - includes analysis and visualization
3. Figure 6b - include analysis and visualization
4. Percent increase code
5. Additional plotting to look at tocopherol isoforms in embryo tissue

Code chunk 2 and 3 are copied and pasted code but analyze different tissue types. Only code chunk 2 is commented somewhat well. Copy and pasting was the easier option at the time to do that instead write things into functions. Code could be much better written as well

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gdata)
library(data.table)
library(readxl)
library(tidyverse)
library(car)
library(DescTools)
library(patchwork)
library(multcomp)
```
```{r figure 6a}
### data from 2022 analysis for 20GH fresh samples
re <-   read_xlsx("data/20GH_POR_DATA_2022.xlsx", sheet = 2)[,-c(1,5)]
tissues <- c("9.3-41_Embryo","9.3-41_Endosperm","9.3-5_Embryo","9.3-5_Endosperm")
traits <- c("a.T", "d.T", "g.T", "a.T3", "d.T3", "g.T3", "Total.T", "Total.T3", "Total.TT3","Chla", "Total.Carots")
re$Genotype <- gsub("-","*",re$Genotype)

#format names for figures
re$Genotype <- gsub("\\+\\*\\*\\*", "por1/+;por2/por2", re$Genotype)
re$Genotype <- gsub("\\*\\*\\+\\*", "por1/por1;por2/+", re$Genotype)
re$Genotype <- gsub("\\*\\*\\*\\*", "por1/por1;por2/por2", re$Genotype)
re$Genotype <- gsub("\\+\\+\\*\\*", "por2/por2", re$Genotype)
re$Genotype <- gsub("\\*\\*\\+\\+", "por1/por1", re$Genotype)
re$Genotype <- gsub("\\+\\+\\+\\+", "WT",re$Genotype)

results_list <- list()

#perform Tukey's HSD on every trait wanted
#check for outliers  
for ( i in 1: length(traits)){
  #get trait (i.e. tocochromonal) and tissue type
  x <-  unlist(as.vector( re[,traits[i]]))
  df <- data.frame("TT" = x, "Genotype" = re$Genotype, "tissue" = re$Tissue)
  df <- df[df$tissue %in% c("9.3-5_Embryo","9.3-41_Embryo"),]
  df <- df [,c(1,2)]
  df$Genotype <- as.factor(df$Genotype)

  # perform aov test
  x <- aov(TT~ Genotype, df)
  # Calculate critical value from t-distribution
  critical_value <- qt(1 - alpha_adjusted/2, df = x$df.residual)
  alpha_adjusted <- 0.05 / length(df[,1])
  # Identify outliers
  deleted_res <- rstudent(x)
  outliers <- df[which(abs(deleted_res) > critical_value),]
  print(outliers)
  
  #perform Tukey HSD and get letters for plotting
  m <- TukeyHSD(x)
  gl <- glht(x, mcp(Genotype = "Tukey"))
  tuk.cld2 <- cld(gl)$mcletters$Letters
  result_df <- data.frame(
    Genotype = names(tuk.cld2),
    name = rep(traits[i],4),
    cld = tuk.cld2
  )
  # Store the result data frame in the list
  results_list[[i]] <- result_df
}


tukey <- data.table::rbindlist(results_list)
tukey <- tukey[tukey$name %in% c("Total.T", "Total.T3","Total.Carots","Chla"),]

#Formatting for plot
re <-   re[re$Tissue %in% c("9.3-5_Embryo", "9.3-41_Embryo"),]
#remove Rep, Sample_ID, Description columns
re <- re[,-c(2,3,5)]
re <- re %>% pivot_longer(!c(Tissue, Genotype))
annotations <- re %>%
  group_by(name) %>%
  summarize(value = max(value), .groups = 'drop')
annotations <- left_join(tukey, annotations, by = c("name"))
annotations$name <- gsub(".T$", " Tocopherol", annotations$name)
annotations$name <- gsub(".T3$", " Tocotrienol", annotations$name)
annotations$name <- gsub(".Carots$", " Carotenoids", annotations$name)
annotations$name <- gsub("Chla", "Chlorophyll a", annotations$name)
re <- re[re$name %in% c("Total.T", "Total.T3","Total.Carots","Chla"),]
re$name <- gsub(".T$", " Tocopherol", re$name)
re$name <- gsub(".T3$", " Tocotrienol", re$name)
re$name <- gsub(".Carots$", " Carotenoids", re$name)
re$name <- gsub("Chla", "Chlorophyll a", re$name)
re$Tissue <- as.factor(re$Tissue)
re$Tissue <- gsub("_.*", "",re$Tissue)
re$Genotype <- factor(re$Genotype, level=c('WT', 'por2/por2','por1/+;por2/por2',  'por1/por1;por2/por2'  ))
re$name <- factor(re$name, levels = c("Total Carotenoids","Total Tocotrienol",  "Total Tocopherol", "Chlorophyll a"))
annotations$name <- factor(annotations$name, levels = c("Total Carotenoids", "Total Tocotrienol", "Total Tocopherol", "Chlorophyll a"))



ggplot(re,aes(x = Genotype, y=value, group=Genotype ,width=.8)) +
  geom_boxplot(aes(fill=Genotype)) + 
  geom_point(aes(colour = Tissue)) +
  facet_wrap(~name, scales = "free", ncol = 4,
                strip.position = "top") +

    scale_color_manual(values =c("red", "black"))+
   scale_y_continuous(limits = c(0, NA)) +
  guides(color = guide_legend(override.aes = list(size = 7))) +
  scale_fill_manual(values =c( "#004D40","#004D40",  "greenyellow","#FFC107"))+
  theme_bw()+
  labs(color = "Family")+
  xlab("")+
  theme(
        legend.text = element_text(size = 10),
          plot.title.position = "plot",
        axis.title=element_text(size=30),
        panel.spacing = unit(4, "lines"),
        strip.text = element_text(size = 20),
               axis.text.x = element_text(size=15,face = "italic",colour = "black",angle = 45,hjust = 1, vjust = 1),
        text = element_text(family = "Helvetica"),
        axis.text.y = element_text(size=15,face="bold",colour = "black",angle = 0))+
  geom_text(data = annotations, aes(label = cld, y = value*1.1), position=position_dodge(width=0.9), color = "black", family= "sans", size = 5) +
  theme(legend.key.size = unit(8, 'cm')) 


ggsave("Figure6a.tiff", width = 24, height =8, device='tiff', dpi=700)



```
```{r figure 6b}
### data from 2022 analysis for 20GH fresh samples
re <-  read_xlsx("data/20GH_POR_DATA_2022.xlsx", sheet = 2)[,-c(1,5)]
tissues <- c("9.3-41_Embryo","9.3-41_Endosperm","9.3-5_Embryo","9.3-5_Endosperm")
traits <- c("a.T", "d.T", "g.T", "a.T3", "d.T3", "g.T3", "Total.T", "Total.T3", "Total.TT3","Chla", "Total.Carots")
re$Genotype <- gsub("-","*",re$Genotype)


re$Genotype <- gsub("\\+\\*\\*\\*", "por1/+;por2/por2", re$Genotype)
re$Genotype <- gsub("\\*\\*\\+\\*", "por1/por1;por2/+", re$Genotype)
re$Genotype <- gsub("\\*\\*\\*\\*", "por1/por1;por2/por2", re$Genotype)
re$Genotype <- gsub("\\+\\+\\*\\*", "por2/por2", re$Genotype)
re$Genotype <- gsub("\\*\\*\\+\\+", "por1/por1", re$Genotype)
re$Genotype <- gsub("\\+\\+\\+\\+", "WT",re$Genotype)

#perfom Tukey's HSD on every trait wanted
for ( i in 1: length(traits)){
  x <-  unlist(as.vector( re[,traits[i]]))
  df <- data.frame("TT" = x, "Genotype" = re$Genotype, "tissue" = re$Tissue)
  df <- df[df$tissue %in% c("9.3-5_Endosperm","9.3-41_Endosperm"),]
  df <- df [,c(1,2)]
  df$Genotype <- as.factor(df$Genotype)
  #perform Tukey's test
  if (sum(df$TT) == 0){
    next
  }
  alpha_adjusted <- 0.05 / length(df[,1])

  
  #perform Tukey's test
  x <- aov(TT~ Genotype, df)


  # Calculate critical value from t-distribution
  critical_value <- qt(1 - alpha_adjusted/2, df = x$df.residual)

 # Identify outliers
  deleted_res <- rstudent(x)
  outliers <- df[which(abs(deleted_res) > critical_value),]
  print(outliers)
  gl <- glht(x, mcp(Genotype = "Tukey"))
  tuk.cld2 <- cld(gl)$mcletters$Letters
  result_df <- data.frame(
    Genotype = names(tuk.cld2),
    name = rep(traits[i],4),
    cld = tuk.cld2
  )
  # Store the result data frame in the list
  results_list[[i]] <- result_df
  #diff <- m[, "p adj"]
}
tukey <- data.table::rbindlist(results_list)

tukey <- tukey[tukey$name %in% c("Total.T", "Total.T3","Total.Carots","Chla"),]


re <-   re[re$Tissue %in% c("9.3-5_Endosperm", "9.3-41_Endosperm"),]
#remove Rep, Sample_ID, Description columns
re <- re[,-c(2,3,5)]
re <- re %>% pivot_longer(!c(Tissue, Genotype))

annotations <- re %>%
  group_by(name) %>%
  summarize(value = max(value), .groups = 'drop')

annotations <- left_join(tukey, annotations, by = c("name"))
annotations$name <- gsub(".T$", " Tocopherol", annotations$name)
annotations$name <- gsub(".T3$", " Tocotrienol", annotations$name)
annotations$name <- gsub(".Carots$", " Carotenoids", annotations$name)
annotations$name <- gsub("Chla", "Chlorophyll a", annotations$name)
#re[c("type", "geno")] <- str_split_fixed( re$name, "_", n =2)
#re <- re %>% pivot_wider(names_from = type, values_from = value)
re <- re[re$name %in% c("Total.T", "Total.T3","Total.Carots","Chla"),]
re$name <- gsub(".T$", " Tocopherol", re$name)
re$name <- gsub(".T3$", " Tocotrienol", re$name)
re$name <- gsub(".Carots$", " Carotenoids", re$name)
re$name <- gsub("Chla", "Chlorophyll a", re$name)
re$Tissue <- as.factor(re$Tissue)
re$Tissue <- gsub("_.*", "",re$Tissue)
re$Genotype <- factor(re$Genotype, level=c('WT', 'por2/por2','por1/+;por2/por2',  'por1/por1;por2/por2'  ))
re$name <- factor(re$name, levels = c("Total Carotenoids","Total Tocotrienol",  "Total Tocopherol", "Chlorophyll a"))
annotations$name <- factor(annotations$name, levels = c("Total Carotenoids", "Total Tocotrienol", "Total Tocopherol", "Chlorophyll a"))

ggplot(re,aes(x = Genotype, y=value ,width=.8)) +
  geom_boxplot(aes(fill=Genotype), show.legend =F) + 
  geom_point(aes(colour = Tissue)) +
    geom_text(data= annotations, aes(label = cld, y = value*1.1), position=position_dodge(width=0.9), color = "black", family= "sans", size = 5) +
  facet_wrap(vars(name), scales = "free", ncol = 4) +

    scale_color_manual(values =c("red", "black")) +
   scale_y_continuous(limits = c(0, NA)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  scale_fill_manual(values =c( "#004D40","#004D40",  "greenyellow","#FFC107")) +
  theme_bw() +
  labs(color = "Family") +
  xlab("") +
  theme(
        legend.text = element_text(size = 10),
          plot.title.position = "plot",
        axis.title=element_text(size=30),
        panel.spacing = unit(4, "lines"),
        strip.text = element_text(size = 20),
               axis.text.x = element_text(size=15,face = "italic",colour = "black",angle = 45,hjust = 1, vjust = 1),
        axis.text.y = element_text(size=15,face="bold",colour = "black",angle = 0)) +

  theme(legend.key.size = unit(4, 'cm')) 





ggsave("Figure6b.tiff", width = 24, height =8, device='tiff', dpi=700)

```

```{r percent increases for embryo tissue}
#calculates percentages for paper
calculate_percent_increase <- function(original_value, new_value) {
  # Calculate the difference
  difference <- new_value - original_value
  
  # Calculate percent increase
  percent_increase <- (difference / original_value) * 100
  
  # Return the percent increase
  return(percent_increase)
}

x <- re %>% group_by(Tissue, Genotype, name) %>% dplyr::summarise(mean_values = mean(value))

WT <- x %>% group_by(name, Tissue) %>% dplyr::mutate(percent = calculate_percent_increase(mean_values[Genotype == "WT"], mean_values[Genotype == "por1/por1;por2/por2"]))

por2 <- x %>% group_by(name, Tissue) %>% dplyr::mutate(percent = calculate_percent_increase(mean_values[Genotype == "por2/por2"], mean_values[Genotype == "por1/por1;por2/por2"]))

por1 <- x %>% group_by(name, Tissue) %>% dplyr::mutate(percent = calculate_percent_increase(mean_values[Genotype == "por1/+;por2/por2"], mean_values[Genotype == "por1/por1;por2/por2"]))


```
```{r plot for embryo tissue- isoforms}
### data from 2022 analysis for 20GH fresh samples
re <-  read_xlsx("../data/20GH_POR_DATA_2022.xlsx", sheet = 2)[,-c(1,5)]
tissues <- c("9.3-41_Embryo","9.3-41_Endosperm","9.3-5_Embryo","9.3-5_Endosperm")
traits <- c("a.T", "d.T", "g.T", "a.T3", "d.T3", "g.T3", "Total.T", "Total.T3", "Total.TT3","Chla", "Total.Carots")
converted_vector <- gsub("^a", "α", traits)
converted_vector <- gsub("d", "δ", converted_vector)
converted_vector <- gsub("g", "γ", converted_vector)
converted_vector <- gsub("\\.T3$", " Tocotrienol", converted_vector)
converted_vector <- gsub("\\.T$", " Tocopherol", converted_vector)

# Replace ".T3" with " Tocotrienol"



colnames(re)[4] <- "geno"
#colnames(re)[6:16] <- c("$a$")
re$geno <- gsub("-","*",re$geno)


#create dataframes
tukey <- data.frame("g1" = NULL, "g2" = NULL, "trait" = NULL, "pval" = NULL)
plotting <- data.frame("trait" = NULL,  "char" = NULL, "geno" = NULL)

#perfom Tukey's HSD on every trait wanted
for ( i in 1: length(traits)){
  x <-  unlist(as.vector( re[,traits[i]]))
  
  df <- data.frame("TT" = x, "geno" = re$geno, "tissue" = re$Tissue)
  df <- df[df$tissue %in% c("9.3-5_Embryo","9.3-41_Embryo"),]
  
  df <- df [,c(1,2)]
  
  
  #perform Tukey's test
  x <- aov(lm(TT~ geno, df))
  m <- TukeyHSD(x)
  
  #assign characters for significance values
  char <- c()
  if (m$geno[1,4] < 0.05){
    char[1] <- "a"
    if(m$geno[4,4] < 0.05){
      if(m$geno[6,4] < 0.05){
        char[c(1,2,3,4)] <- c("a", "b", "c","d")
      }else{
        char[c(1,2,3,4)] <- c("a", "b", "c","c")
      }
    }else{
      if(m$geno[6,4] < 0.05){
        char[c(1,2,3,4)] <- c("a", "b", "b","c")
      }else{
        char[c(1,2,3,4)] <- c("a", "b", "b","b")
      }
    }
    
  }else{
  if(m$geno[4,4] < 0.05){
      if(m$geno[6,4] < 0.05){
        char[c(1,2,3,4)] <- c("a", "a", "b","c")
      }else{
        char[c(1,2,3,4)] <- c("a", "a", "b","b")
      }
  }else{
        if(m$geno[6,4] < 0.05){
          char[c(1,2,3,4)] <- c("a", "a", "a","b")
        }else{
          char[c(1,2,3,4)] <- c("a", "a", "a","a")
        }
   }
  }
  tukey <- rbind(tukey, data.frame("g1" =substr(row.names(m$geno),1,4),"g2" =substr(row.names(m$geno),5,8) , "trait" = rep(traits[i],6),"pval" = m$geno[,4]))  
  plotting <- rbind(plotting, data.frame( "trait" = rep(traits[i],4), "char" = char, "geno" = c("----", "+---", "++--", "++++")))
  
}


#read in mean and se for plotting and format for GGplot
infile <- fread("../20GH_fresh_samples_Chla_2022_analysis_mean_se.csv",data.table = F)
infile <-   infile[infile$Tissue == "9.3-5_Embryo",]
infile <- infile %>% pivot_longer(!c(Tissue, trait))
infile[c("type", "geno")] <- str_split_fixed( infile$name, "_", n =2)
infile <- infile[,-3]
infile <- infile %>% pivot_wider(names_from = type, values_from = value)
infile <- inner_join(infile,plotting, by = c("trait", "geno"))
colnames(infile)[3] <- "Genotype"

#select traits of interest
infile <- infile[infile$trait %in% c("Total.T", "Total.T3", "Total.TT3","Chla"),]

#edit for mistakes of significant differences made in the for loop
infile[c(5,6,7), 6] <- c("b","ab","ab")


ggplot(infile,aes(x = trait, y=mean, group=Genotype, fill=Genotype, width=.8)) +
  geom_bar(stat="identity", position=position_dodge(width=0.9)) + 
  geom_errorbar(aes(ymin=mean - se, ymax=mean + se), 
                width=0.2, size=0.8, position=position_dodge(width=0.9))+
  facet_wrap(~trait, scales = "free", ncol = 3)+
  
  scale_fill_manual(values =c("#FFC107", "#009E73", "#117733","#004D40"))+
  theme_bw()+
  labs('')+
  ylab("Concentration")+
  xlab("") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 40),
        plot.title = element_text(size=18,face = "bold",color="forestgreen"),
        axis.title=element_text(size=18,face="bold"),
        axis.text.x = element_text(size=18,face="bold",colour = "black",angle = 0),
        axis.text.y = element_text(size=25,face="bold",colour = "black",angle = 0))+
  theme(strip.text.x = element_blank()) +
  geom_text(aes( y = mean +se,label = char), position=position_dodge(width=0.9), vjust=-0.1, color = "black", family= "sans", size = 5)+
  theme(legend.key.size = unit(3, 'cm'))


```
